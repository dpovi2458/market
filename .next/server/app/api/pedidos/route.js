"use strict";(()=>{var e={};e.id=132,e.ids=[132],e.modules={11185:e=>{e.exports=require("mongoose")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},67901:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>y,patchFetch:()=>S,requestAsyncStorage:()=>_,routeModule:()=>g,serverHooks:()=>v,staticGenerationAsyncStorage:()=>f});var o={};r.r(o),r.d(o,{POST:()=>m,runtime:()=>c});var i=r(49303),n=r(88716),a=r(60670),d=r(87070),p=r(21067),u=r(52297),s=r(59094);let c="nodejs",l=p.Ry({items:p.IX(p.Ry({producto_id:p.Z_(),titulo:p.Z_(),precio:p.Rx().nonnegative(),cantidad:p.Rx().int().positive(),vendedor_id:p.Z_().optional()})),comprador:p.Ry({nombre:p.Z_().min(1),telefono:p.Z_().min(6),email:p.Z_().email().optional().or(p.i0("").transform(()=>void 0)),punto_entrega:p.Z_().min(1),comentarios:p.Z_().optional()})});async function m(e){try{let t=await e.json(),r=l.parse(t),o=await (0,s.F)(),i=r.items.map(e=>e.producto_id),n=await o.find({_id:{$in:i}}),a=r.items.map(e=>{let t=n.find(t=>String(t._id)===e.producto_id);if(!t||!t.disponible)throw Error(`Producto no disponible: ${e.titulo}`);if(t.stock<e.cantidad)throw Error(`Stock insuficiente para ${t.titulo}`);return{producto_id:t._id,titulo:t.titulo,precio:t.precio,cantidad:e.cantidad,subtotal:t.precio*e.cantidad,vendedor_id:t.vendedor_id}}),p=a.reduce((e,t)=>e+t.subtotal,0),c=function(e){let t=new Set(e.map(e=>e.vendedor_id).filter(Boolean));return 1===t.size?[...t][0]:void 0}(a),m=await (0,u.D)(),g=await m.create({productos:a.map(({vendedor_id:e,...t})=>t),total:p,comprador:r.comprador,vendedor_id:c});return await Promise.all(a.map(e=>o.updateOne({_id:e.producto_id},{$inc:{stock:-e.cantidad}}))),d.NextResponse.json({ok:!0,id:g._id})}catch(t){console.error("Error creando pedido:",t);let e=t?.errors?.[0]?.message||t.message||"Error";return d.NextResponse.json({ok:!1,error:e},{status:400})}}let g=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/pedidos/route",pathname:"/api/pedidos",filename:"route",bundlePath:"app/api/pedidos/route"},resolvedPagePath:"C:\\Users\\dpovi\\Unimarket\\marketplace-facultad\\app\\api\\pedidos\\route.js",nextConfigOutput:"",userland:o}),{requestAsyncStorage:_,staticGenerationAsyncStorage:f,serverHooks:v}=g,y="/api/pedidos/route";function S(){return(0,a.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:f})}},52297:(e,t,r)=>{r.d(t,{D:()=>p});var o=r(11185),i=r.n(o),n=r(39584);let a=new o.Schema({producto_id:{type:o.Schema.Types.ObjectId,ref:"Product",required:!0},titulo:String,precio:Number,cantidad:Number,subtotal:Number}),d=new o.Schema({productos:[a],total:Number,comprador:{nombre:{type:String,required:!0},telefono:{type:String,required:!0},email:String,punto_entrega:{type:String,required:!0},comentarios:String},vendedor_id:{type:String},estado:{type:String,enum:["pendiente","entregado"],default:"pendiente"}},{timestamps:{createdAt:"fecha_pedido",updatedAt:!1}});async function p(){return await (0,n.u)(),i().models.Order||i().model("Order",d,"pedidos")}},59094:(e,t,r)=>{r.d(t,{F:()=>d});var o=r(11185),i=r.n(o),n=r(39584);let a=new o.Schema({titulo:{type:String,required:!0,maxlength:100},descripcion:{type:String,required:!0,maxlength:500},precio:{type:Number,required:!0,min:0},categoria:{type:String,required:!0,enum:["utiles","comida","tecnologia","ropa","otros"]},imagenes:{type:[String],default:[],validate:[e=>e.length<=3,"M\xe1ximo 3 im\xe1genes"]},stock:{type:Number,required:!0,default:0,min:0},disponible:{type:Boolean,default:!0},vendedor_id:{type:String},vendedor_nombre:{type:String}},{timestamps:{createdAt:"fecha_creacion",updatedAt:"fecha_actualizacion"}});async function d(){return await (0,n.u)(),i().models.Product||i().model("Product",a,"productos")}},39584:(e,t,r)=>{r.d(t,{u:()=>p});let o=require("mongodb");var i=r(11185),n=r.n(i);let a=process.env.MONGODB_URI;if(!process.env.MONGODB_URI)throw Error("Add Mongo URI to .env.local");new o.MongoClient(a,{}).connect();let d=global._mongooseConn||null;async function p(){return d&&1===n().connection.readyState||(n().set("strictQuery",!0),d=await n().connect(a,{dbName:"marketplace"}),global._mongooseConn=d),d}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[276,972,67],()=>r(67901));module.exports=o})();